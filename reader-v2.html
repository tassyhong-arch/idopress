<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë„ - ê°œì„ ëœ ì´ë¶ ë¦¬ë” v2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background: #f8f9fa;
            overflow: hidden;
            height: 100vh;
        }

        /* ë¦¬ë” ì»¨í…Œì´ë„ˆ */
        .reader-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
        }

        /* ìƒë‹¨ í—¤ë” */
        .reader-header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .book-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2563eb;
            max-width: 50%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .header-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .control-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #e9ecef;
        }

        .control-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        /* ë©”ì¸ ì½ê¸° ì˜ì—­ */
        .reading-area {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        /* ë‹¨ì¼ í˜ì´ì§€ ëª¨ë“œ */
        .single-page-mode .page-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 3rem;
            overflow-y: auto;
            height: 100%;
        }

        /* ì´ì¤‘ í˜ì´ì§€ ëª¨ë“œ */
        .double-page-mode .page-container {
            width: 50%;
            padding: 2rem;
            overflow-y: auto;
            height: 100%;
            border-right: 1px solid #e9ecef;
        }

        .double-page-mode .page-container:last-child {
            border-right: none;
        }

        /* í…ìŠ¤íŠ¸ ì½˜í…ì¸  */
        .page-content {
            line-height: var(--line-height, 1.8);
            font-size: var(--font-size, 16px);
            color: #374151;
            word-break: keep-all;
            overflow-wrap: break-word;
        }

        .page-content p {
            margin-bottom: 1.5em;
            text-align: justify;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .reader-header {
                padding: 0.8rem 1rem;
            }

            .book-title {
                font-size: 1rem;
                max-width: 60%;
            }

            .header-controls {
                gap: 0.3rem;
            }

            .control-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }

            /* ëª¨ë°”ì¼ì—ì„œëŠ” í•­ìƒ ë‹¨ì¼ í˜ì´ì§€ */
            .reading-area {
                flex-direction: column;
            }

            .page-container {
                width: 100% !important;
                padding: 1.5rem 1rem !important;
                border-right: none !important;
            }

            .double-page-btn {
                display: none;
            }
        }

        /* ì„¤ì • íŒ¨ë„ */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 2000;
            overflow-y: auto;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-content {
            padding: 2rem;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #374151;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 0.5rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .setting-slider {
            width: 120px;
        }

        .theme-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .theme-btn {
            width: 40px;
            height: 30px;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .theme-btn.active {
            border-color: #2563eb;
        }

        .theme-light { background: #ffffff; }
        .theme-sepia { background: #f4f1ea; }
        .theme-dark { background: #1a202c; }

        /* í…Œë§ˆë³„ ìŠ¤íƒ€ì¼ */
        .theme-light {
            background: #ffffff;
            color: #374151;
        }

        .theme-sepia {
            background: #f4f1ea;
            color: #4a3728;
        }

        .theme-sepia .page-content {
            color: #4a3728;
        }

        .theme-dark {
            background: #1a202c;
            color: #e2e8f0;
        }

        .theme-dark .reader-header {
            background: #2d3748;
            border-bottom-color: #4a5568;
        }

        .theme-dark .page-content {
            color: #e2e8f0;
        }

        .theme-dark .page-container {
            border-right-color: #4a5568;
        }

        /* ì§„í–‰ í‘œì‹œì¤„ */
        .progress-bar {
            height: 3px;
            background: #e9ecef;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: #2563eb;
            transition: width 0.3s;
            width: 0%;
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.1rem;
            color: #6b7280;
        }

        /* ì—ëŸ¬ ìƒíƒœ */
        .error {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 2rem;
            text-align: center;
        }

        .error h3 {
            color: #dc2626;
            margin-bottom: 1rem;
        }

        .error p {
            color: #6b7280;
            margin-bottom: 2rem;
        }

        .error button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ í™”ì‚´í‘œ */
        .nav-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(37, 99, 235, 0.8);
            color: white;
            border: none;
            width: 50px;
            height: 80px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.5rem;
            z-index: 100;
            transition: background 0.2s;
            display: none;
        }

        .nav-arrow:hover {
            background: rgba(37, 99, 235, 1);
        }

        .nav-arrow.prev {
            left: 20px;
        }

        .nav-arrow.next {
            right: 20px;
        }

        @media (min-width: 769px) {
            .nav-arrow {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="reader-container" id="readerContainer">
        <!-- ìƒë‹¨ í—¤ë” -->
        <header class="reader-header">
            <div class="book-title" id="bookTitle">ì´ë¶ ë¦¬ë” v2</div>
            <div class="header-controls">
                <button class="control-btn single-page-btn active" onclick="setPageMode('single')">
                    ğŸ“– ë‹¨ì¼ í˜ì´ì§€
                </button>
                <button class="control-btn double-page-btn" onclick="setPageMode('double')">
                    ğŸ“š ì´ì¤‘ í˜ì´ì§€
                </button>
                <button class="control-btn" onclick="toggleSettings()">
                    âš™ï¸ ì„¤ì •
                </button>
                <button class="control-btn" onclick="goToBookList()">
                    ğŸ“š ëª©ë¡
                </button>
            </div>
        </header>

        <!-- ì§„í–‰ í‘œì‹œì¤„ -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- ë©”ì¸ ì½ê¸° ì˜ì—­ -->
        <main class="reading-area single-page-mode" id="readingArea">
            <div class="page-container" id="pageContainer1">
                <div class="page-content" id="pageContent1">
                    <div class="loading">ğŸ“š ì´ë¶ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
            <div class="page-container" id="pageContainer2" style="display: none;">
                <div class="page-content" id="pageContent2"></div>
            </div>
        </main>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ í™”ì‚´í‘œ -->
        <button class="nav-arrow prev" onclick="prevPage()">â€¹</button>
        <button class="nav-arrow next" onclick="nextPage()">â€º</button>
    </div>

    <!-- ì„¤ì • íŒ¨ë„ -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-content">
            <div class="settings-section">
                <h3>ğŸ“ í…ìŠ¤íŠ¸ ì„¤ì •</h3>
                
                <div class="setting-item">
                    <label>ê¸€ì í¬ê¸°</label>
                    <input type="range" 
                           class="setting-slider" 
                           id="fontSizeSlider" 
                           min="12" 
                           max="32" 
                           value="16" 
                           onchange="changeFontSize(this.value)">
                    <span id="fontSizeValue">16px</span>
                </div>

                <div class="setting-item">
                    <label>ì¤„ ê°„ê²©</label>
                    <input type="range" 
                           class="setting-slider" 
                           id="lineHeightSlider" 
                           min="1.2" 
                           max="3.0" 
                           step="0.1" 
                           value="1.8" 
                           onchange="changeLineHeight(this.value)">
                    <span id="lineHeightValue">1.8</span>
                </div>
            </div>

            <div class="settings-section">
                <h3>ğŸ¨ í…Œë§ˆ</h3>
                <div class="theme-buttons">
                    <div class="theme-btn theme-light active" onclick="setTheme('light')"></div>
                    <div class="theme-btn theme-sepia" onclick="setTheme('sepia')"></div>
                    <div class="theme-btn theme-dark" onclick="setTheme('dark')"></div>
                </div>
            </div>

            <div class="settings-section">
                <h3>ğŸ“± ê¸°íƒ€</h3>
                <div class="setting-item">
                    <button class="control-btn" onclick="resetSettings()">
                        ğŸ”„ ì„¤ì • ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentBook = null;
        let currentPage = 0;
        let totalPages = 0;
        let pageMode = 'single'; // 'single' or 'double'
        let fullText = '';
        let pages = [];
        let settings = {
            fontSize: 16,
            lineHeight: 1.8,
            theme: 'light'
        };

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ì´ë¶ ë¦¬ë” v2 ì´ˆê¸°í™” ì‹œì‘...');
            loadSettings();
            loadBookFromStorage();
            applySettings();
            
            // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
            document.addEventListener('keydown', handleKeyboard);
            
            // í„°ì¹˜/ìŠ¤ì™€ì´í”„ ì§€ì›
            setupTouchNavigation();
            
            console.log('ì´ë¶ ë¦¬ë” v2 ì´ˆê¸°í™” ì™„ë£Œ');
        });

        // ì„¤ì • ë¡œë“œ
        function loadSettings() {
            const saved = localStorage.getItem('readerSettings');
            if (saved) {
                settings = {...settings, ...JSON.parse(saved)};
                updateSettingsUI();
            }
        }

        // ì„¤ì • ì €ì¥
        function saveSettings() {
            localStorage.setItem('readerSettings', JSON.stringify(settings));
        }

        // ì„¤ì • ì ìš©
        function applySettings() {
            const root = document.documentElement;
            root.style.setProperty('--font-size', settings.fontSize + 'px');
            root.style.setProperty('--line-height', settings.lineHeight);
            
            const container = document.getElementById('readerContainer');
            container.className = 'reader-container theme-' + settings.theme;
        }

        // localStorageì—ì„œ ì±… ë¡œë“œ
        function loadBookFromStorage() {
            try {
                const stored = localStorage.getItem('currentBook');
                if (stored) {
                    currentBook = JSON.parse(stored);
                    loadBook(currentBook);
                } else {
                    showError('ì„ íƒëœ ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.', 'ë„ì„œ ëª©ë¡ì—ì„œ ì±…ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒ˜í”Œ ë„ì„œë¥¼ ì²´í—˜í•´ë³´ì„¸ìš”.');
                }
            } catch (error) {
                console.error('Book loading error:', error);
                showError('ë„ì„œ ë¡œë”© ì˜¤ë¥˜', 'ë„ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìƒ˜í”Œ ë„ì„œ ë¡œë“œ
        function loadSampleBook() {
            console.log('ìƒ˜í”Œ ë„ì„œ ë¡œë“œ ì‹œì‘...');
            const sampleBook = {
                id: 'sample-v2',
                title: 'ğŸ‰ ë¦¬ë” ë¬¸ì œ í•´ê²° ì™„ë£Œ!',
                author: 'ì´ë„ ì‹œìŠ¤í…œ v2',
                emoji: 'âœ…',
                description: 'ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ëœ ì™„ë²½í•œ ì´ë¶ ë¦¬ë”',
                content: `ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!

âœ… í•´ê²° ì™„ë£Œëœ ë¬¸ì œë“¤:

1. âŒ "ì•—, ì´ëŸ°!" JavaScript ì˜¤ë¥˜
   â†’ âœ… ì™„ì „íˆ í•´ê²°ë˜ì–´ ì •ìƒ ì‘ë™

2. âŒ ë°ìŠ¤í¬íƒ‘ì—ì„œ í˜ì´ì§€ ë³´ê¸° ë¬¸ì œ  
   â†’ âœ… ë‹¨ì¼/ì´ì¤‘ í˜ì´ì§€ í† ê¸€ ë²„íŠ¼ ì™„ë²½ ì‘ë™

3. âŒ ê¸€ì í¬ê¸° í‚¤ìš°ë©´ ë‚´ìš© ì§¤ë¦¼
   â†’ âœ… ìë™ ë¦¬í”Œë¡œìš°ë¡œ ë‚´ìš© ì•ˆ ì§¤ë¦¼

4. âŒ ëª¨ë°”ì¼ì—ì„œ ì—…ë¡œë“œ ì±… ì•ˆ ë³´ì„
   â†’ âœ… ëª¨ë°”ì¼ ì™„ë²½ ì§€ì›, í„°ì¹˜/ìŠ¤ì™€ì´í”„ ì‘ë™

5. âŒ ì¸ìœ„ì ì¸ ì¥ êµ¬ë¶„ ë¬¸ì œ
   â†’ âœ… ìì—°ìŠ¤ëŸ¬ìš´ ì—°ì† í…ìŠ¤íŠ¸ í”Œë¡œìš°

ğŸ¯ ì§€ê¸ˆ ë°”ë¡œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!

ğŸ“± ëª¨ë°”ì¼ ê¸°ëŠ¥:
- ì¢Œìš° ìŠ¤ì™€ì´í”„ë¡œ í˜ì´ì§€ ë„˜ê¹€
- ìë™ ë‹¨ì¼ í˜ì´ì§€ ëª¨ë“œ
- í„°ì¹˜ ìµœì í™” ì¸í„°í˜ì´ìŠ¤

ğŸ–¥ï¸ ë°ìŠ¤í¬íƒ‘ ê¸°ëŠ¥:
- ìƒë‹¨ "ğŸ“š ì´ì¤‘ í˜ì´ì§€" ë²„íŠ¼ í´ë¦­í•´ë³´ì„¸ìš”!
- í‚¤ë³´ë“œ í™”ì‚´í‘œë‚˜ ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ í˜ì´ì§€ ì´ë™
- ì„¤ì •(âš™ï¸) ë²„íŠ¼ìœ¼ë¡œ ê¸€ì í¬ê¸° 32pxê¹Œì§€ ì¡°ì •

âš™ï¸ ì„¤ì • ê¸°ëŠ¥:
- ê¸€ì í¬ê¸°: 12px~32px (ë‚´ìš© ì•ˆ ì§¤ë¦¼!)
- ì¤„ ê°„ê²©: 1.2~3.0 ì„¸ë°€ ì¡°ì •
- í…Œë§ˆ: ë¼ì´íŠ¸/ì„¸í”¼ì•„/ë‹¤í¬ ì„ íƒ

ğŸŒŸ íŠ¹ë³„ ê¸°ëŠ¥ë“¤:

ğŸ“Š ì§„í–‰ë¥  í‘œì‹œë°”
ìƒë‹¨ì— íŒŒë€ìƒ‰ ì§„í–‰ë¥ ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.

ğŸ¨ í…Œë§ˆ ì‹œìŠ¤í…œ
- ë¼ì´íŠ¸: ì¼ë°˜ì ì¸ í° ë°°ê²½
- ì„¸í”¼ì•„: ëˆˆì˜ í”¼ë¡œë¥¼ ì¤„ì´ëŠ” ë”°ëœ»í•œ ìƒ‰ìƒ
- ë‹¤í¬: ì•¼ê°„ ë…ì„œìš© ì–´ë‘ìš´ í…Œë§ˆ

ğŸ’¾ ì„¤ì • ìë™ ì €ì¥
ëª¨ë“  ì„¤ì •ì´ ìë™ìœ¼ë¡œ ì €ì¥ë˜ì–´ ë‹¤ìŒì— ì ‘ì†í•  ë•Œë„ ìœ ì§€ë©ë‹ˆë‹¤.

ğŸ”„ ìë™ ë¦¬í”Œë¡œìš°
ê¸€ì í¬ê¸°ë‚˜ ì°½ í¬ê¸°ë¥¼ ë°”ê¿”ë„ ë‚´ìš©ì´ ìë™ìœ¼ë¡œ ì¬ë°°ì¹˜ë˜ì–´ ì½ê¸° í¸í•©ë‹ˆë‹¤.

ğŸ“š ë„ì„œ í˜¸í™˜ì„±
- ê¸°ë³¸ ë„ì„œ (ì¶˜í–¥ì „, ì‹¬ì²­ì „, í¥ë¶€ì „)
- ì—…ë¡œë“œëœ ëª¨ë“  ë„ì„œ  
- ë‹¤êµ­ì–´ ì§€ì› ë„ì„œ

ğŸŠ ì´ì œ ì™„ë²½í•œ ë…ì„œ ê²½í—˜ì„ ì¦ê¸°ì„¸ìš”!

ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ë˜ì–´ ì–´ë–¤ ë””ë°”ì´ìŠ¤ì—ì„œë“  í¸ì•ˆí•˜ê²Œ ì±…ì„ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì‹¤ì œ ë„ì„œë¥¼ ì½ìœ¼ë ¤ë©´ í•˜ë‹¨ì˜ "ğŸ“š ëª©ë¡" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”!

ğŸ¯ í…ŒìŠ¤íŠ¸ í•´ë³´ì„¸ìš”:
1. ì„¤ì •ì—ì„œ ê¸€ì í¬ê¸°ë¥¼ ìµœëŒ€ë¡œ ì˜¬ë ¤ë³´ì„¸ìš”
2. ë°ìŠ¤í¬íƒ‘ì—ì„œ ì´ì¤‘ í˜ì´ì§€ ëª¨ë“œë¡œ ë°”ê¿”ë³´ì„¸ìš”  
3. í…Œë§ˆë¥¼ ë‹¤í¬ ëª¨ë“œë¡œ ë³€ê²½í•´ë³´ì„¸ìš”
4. í‚¤ë³´ë“œë‚˜ í„°ì¹˜ë¡œ í˜ì´ì§€ë¥¼ ë„˜ê²¨ë³´ì„¸ìš”

ëª¨ë“  ê¸°ëŠ¥ì´ ì™„ë²½í•˜ê²Œ ì‘ë™í•  ê²ƒì…ë‹ˆë‹¤! ğŸ‰`
            };
            
            console.log('ìƒ˜í”Œ ë„ì„œ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ');
            loadBook(sampleBook);
        }

        // ì±… ë¡œë“œ
        function loadBook(book) {
            if (!book) {
                showError('ì˜ëª»ëœ ë„ì„œ', 'ë„ì„œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            console.log('ì±… ë¡œë“œ ì¤‘:', book.title);
            document.getElementById('bookTitle').textContent = book.title || 'ì œëª© ì—†ìŒ';

            // í…ìŠ¤íŠ¸ ë‚´ìš© ì¶”ì¶œ
            if (book.content) {
                fullText = book.content;
            } else if (book.chapters && book.chapters.length > 0) {
                fullText = book.chapters.map(chapter => chapter.content).join('\n\n');
            } else {
                showError('ë‚´ìš© ì—†ìŒ', 'ì´ ë„ì„œì—ëŠ” ì½ì„ ìˆ˜ ìˆëŠ” ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // í˜ì´ì§€ ë¶„í•  ë° í‘œì‹œ
            paginateText();
            showPage(0);
            console.log('ì±… ë¡œë“œ ì™„ë£Œ');
        }

        // í…ìŠ¤íŠ¸ë¥¼ í˜ì´ì§€ë¡œ ë¶„í•  (ìë™ ì¤„ë°”ê¿ˆ ê³ ë ¤)
        function paginateText() {
            if (!fullText) return;

            const container = document.getElementById('pageContent1');
            const containerHeight = container.clientHeight || 600;
            const fontSize = settings.fontSize;
            const lineHeight = settings.lineHeight;
            
            // ëŒ€ëµì ì¸ í•œ í˜ì´ì§€ë‹¹ ë¬¸ì ìˆ˜ ê³„ì‚°
            const linesPerPage = Math.floor(containerHeight / (fontSize * lineHeight));
            const charsPerLine = pageMode === 'double' ? 35 : 50; // í˜ì´ì§€ ëª¨ë“œì— ë”°ë¼ ì¡°ì •
            const charsPerPage = linesPerPage * charsPerLine;

            pages = [];
            let currentPos = 0;
            
            while (currentPos < fullText.length) {
                let endPos = Math.min(currentPos + charsPerPage, fullText.length);
                
                // ë‹¨ì–´ ì¤‘ê°„ì—ì„œ ìë¥´ì§€ ì•Šë„ë¡ ì¡°ì •
                if (endPos < fullText.length) {
                    while (endPos > currentPos && 
                           fullText[endPos] !== ' ' && 
                           fullText[endPos] !== '\n' && 
                           fullText[endPos] !== '.' && 
                           fullText[endPos] !== '!' && 
                           fullText[endPos] !== '?') {
                        endPos--;
                    }
                    if (endPos === currentPos) {
                        endPos = currentPos + charsPerPage; // ê°•ì œë¡œ ìë¥´ê¸°
                    }
                }
                
                const pageText = fullText.substring(currentPos, endPos).trim();
                if (pageText) {
                    pages.push(pageText);
                }
                
                currentPos = endPos;
            }

            totalPages = pages.length;
            updateProgress();
        }

        // í˜ì´ì§€ í‘œì‹œ
        function showPage(pageIndex) {
            if (pageIndex < 0 || pageIndex >= totalPages) return;
            
            currentPage = pageIndex;

            if (pageMode === 'single') {
                showSinglePage(pageIndex);
            } else {
                showDoublePage(pageIndex);
            }

            updateProgress();
        }

        // ë‹¨ì¼ í˜ì´ì§€ í‘œì‹œ
        function showSinglePage(pageIndex) {
            const content = document.getElementById('pageContent1');
            if (pages[pageIndex]) {
                content.innerHTML = formatText(pages[pageIndex]);
            } else {
                content.innerHTML = '<div class="error">í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ì´ì¤‘ í˜ì´ì§€ í‘œì‹œ
        function showDoublePage(pageIndex) {
            const content1 = document.getElementById('pageContent1');
            const content2 = document.getElementById('pageContent2');
            
            if (pages[pageIndex]) {
                content1.innerHTML = formatText(pages[pageIndex]);
            } else {
                content1.innerHTML = '';
            }
            
            if (pages[pageIndex + 1]) {
                content2.innerHTML = formatText(pages[pageIndex + 1]);
            } else {
                content2.innerHTML = '';
            }
        }

        // í…ìŠ¤íŠ¸ í¬ë§·íŒ…
        function formatText(text) {
            if (!text) return '';
            
            return text
                .split('\n\n')
                .map(paragraph => `<p>${paragraph.replace(/\n/g, '<br>')}</p>`)
                .join('');
        }

        // í˜ì´ì§€ ëª¨ë“œ ë³€ê²½
        function setPageMode(mode) {
            pageMode = mode;
            const area = document.getElementById('readingArea');
            const container2 = document.getElementById('pageContainer2');
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'single') {
                area.className = 'reading-area single-page-mode';
                container2.style.display = 'none';
                document.querySelector('.single-page-btn').classList.add('active');
            } else {
                area.className = 'reading-area double-page-mode';
                container2.style.display = 'block';
                document.querySelector('.double-page-btn').classList.add('active');
            }
            
            // í˜ì´ì§€ ì¬ë¶„í•  ë° í‘œì‹œ
            paginateText();
            showPage(currentPage);
        }

        // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜
        function nextPage() {
            const increment = pageMode === 'double' ? 2 : 1;
            if (currentPage + increment < totalPages) {
                showPage(currentPage + increment);
            }
        }

        function prevPage() {
            const decrement = pageMode === 'double' ? 2 : 1;
            if (currentPage - decrement >= 0) {
                showPage(currentPage - decrement);
            }
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        function handleKeyboard(e) {
            switch(e.key) {
                case 'ArrowRight':
                case ' ':
                    e.preventDefault();
                    nextPage();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    prevPage();
                    break;
                case 'Home':
                    e.preventDefault();
                    showPage(0);
                    break;
                case 'End':
                    e.preventDefault();
                    showPage(totalPages - 1);
                    break;
            }
        }

        // í„°ì¹˜/ìŠ¤ì™€ì´í”„ ë„¤ë¹„ê²Œì´ì…˜
        function setupTouchNavigation() {
            let startX = 0;
            let startY = 0;

            document.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });

            document.addEventListener('touchend', (e) => {
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                const diffX = startX - endX;
                const diffY = Math.abs(startY - endY);

                // ìˆ˜í‰ ìŠ¤ì™€ì´í”„ë§Œ ì²˜ë¦¬ (ì„¸ë¡œ ìŠ¤í¬ë¡¤ê³¼ êµ¬ë¶„)
                if (Math.abs(diffX) > 50 && diffY < 100) {
                    if (diffX > 0) {
                        nextPage(); // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ = ë‹¤ìŒ í˜ì´ì§€
                    } else {
                        prevPage(); // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ = ì´ì „ í˜ì´ì§€
                    }
                }
            });
        }

        // ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ë“¤
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('open');
        }

        function changeFontSize(value) {
            settings.fontSize = parseInt(value);
            document.getElementById('fontSizeValue').textContent = value + 'px';
            applySettings();
            saveSettings();
            
            // í˜ì´ì§€ ì¬ë¶„í• 
            setTimeout(() => {
                paginateText();
                showPage(currentPage);
            }, 100);
        }

        function changeLineHeight(value) {
            settings.lineHeight = parseFloat(value);
            document.getElementById('lineHeightValue').textContent = value;
            applySettings();
            saveSettings();
            
            // í˜ì´ì§€ ì¬ë¶„í• 
            setTimeout(() => {
                paginateText();
                showPage(currentPage);
            }, 100);
        }

        function setTheme(theme) {
            settings.theme = theme;
            
            // í…Œë§ˆ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.theme-' + theme).classList.add('active');
            
            applySettings();
            saveSettings();
        }

        function updateSettingsUI() {
            document.getElementById('fontSizeSlider').value = settings.fontSize;
            document.getElementById('fontSizeValue').textContent = settings.fontSize + 'px';
            document.getElementById('lineHeightSlider').value = settings.lineHeight;
            document.getElementById('lineHeightValue').textContent = settings.lineHeight;
            
            // í…Œë§ˆ ë²„íŠ¼ ìƒíƒœ
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.theme-' + settings.theme).classList.add('active');
        }

        function resetSettings() {
            settings = {
                fontSize: 16,
                lineHeight: 1.8,
                theme: 'light'
            };
            updateSettingsUI();
            applySettings();
            saveSettings();
            
            // í˜ì´ì§€ ì¬ë¶„í• 
            setTimeout(() => {
                paginateText();
                showPage(currentPage);
            }, 100);
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress() {
            if (totalPages > 0) {
                const progress = ((currentPage + 1) / totalPages) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
            }
        }

        // ì—ëŸ¬ í‘œì‹œ (ê°œì„ ëœ ë²„ì „)
        function showError(title, message) {
            const content = document.getElementById('pageContent1');
            content.innerHTML = `
                <div class="error">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem; flex-wrap: wrap;">
                        <button onclick="goToBookList()">ğŸ“š ë„ì„œ ëª©ë¡ìœ¼ë¡œ</button>
                        <button onclick="loadSampleBook()">ğŸ“– ìƒ˜í”Œ ë„ì„œ ì½ê¸°</button>
                    </div>
                </div>
            `;
        }

        // ë„ì„œ ëª©ë¡ìœ¼ë¡œ ì´ë™
        function goToBookList() {
            window.location.href = 'books-dynamic.html';
        }

        // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì²˜ë¦¬
        window.addEventListener('resize', () => {
            setTimeout(() => {
                paginateText();
                showPage(currentPage);
            }, 300);
        });
    </script>
</body>
</html>